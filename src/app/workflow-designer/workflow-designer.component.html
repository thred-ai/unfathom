<div
  class="w-100 h-100 d-flex justify-content-center align-items-start"
  #parent
>
  <div
    class="w-100 h-100 d-flex justify-content-between align-items-center section-background"
  >
    <div class="w-100 h-100" style="overflow: hidden" id="container"></div>

    <!-- <div
      class="w-100 h-100 renderer primary-background"
      *ngIf="selectedFile?.data?.ngArguments?.scene && workflow && theme"
    >
      <app-world-designer
        *ngIf="visible"
        [theme]="theme"
        [scene]="selectedFile?.data?.ngArguments?.scene"
        [project]="workflow"
      ></app-world-designer>
    </div> -->

    <div
      class="h-100 border-table-left primary-background"
      style="width: 400px !important; overflow-x: hidden; flex-shrink: 0"
      *ngIf="selectedData"
    >
      <app-extended-menu
        [data]="selectedData.data"
        (close)="selectedData = undefined"
        (changed)="extendedMenuFinish($event)"
      >
      </app-extended-menu>
    </div>

    <div
      *ngIf="selectedFile"
      class="h-100 border-table-left"
      style="width: 250px !important; flex-shrink: 0; overflow-x: hidden"
    >
      <div class="primary-background h-100 w-100">
        <mat-tab-group
          #menu
          class="w-100 h-100"
          dynamicHeight
          animationDuration="0ms"
          (selectedTabChange)="selectedData = undefined"
        >
          <mat-tab class="tab">
            <ng-template mat-tab-label>
              <span class="primary-text"> SCENE </span>
              <!-- <mat-icon class="primary-text"> public </mat-icon> -->
            </ng-template>
            <ng-template matTabContent>
              <div
                class="h-100 d-flex justify-content-center align-items-center flex-column position-relative"
              >
                <div
                  class="w-100 h-100 p-2 pb-5"
                  style="overflow-y: scroll"
                  *ngIf="selectedFile"
                >
                  <div
                    class="w-100"
                    *ngIf="
                      selectedFile &&
                      selectedFile.data?.ngArguments?.scene as scene
                    "
                  >
                    <ion-item
                      slot="header"
                      class="primary-text w-100 border-0 file-item"
                      role="button"
                      (click)="openWorldMenu()"
                    >
                      <ng-container>
                        <ion-thumbnail
                          slot="end"
                          [style.--border-radius]="'6px'"
                        >
                          <!-- <img
                        class="border-table p-0"
                        [src]="scene.images[0]"
                      /> -->
                        </ion-thumbnail>
                        <ion-label style="font-size: small"
                          >Environment</ion-label
                        >
                        <ion-icon
                          class="secondary-text my-auto"
                          style="font-size: 15px; cursor: pointer"
                          [name]="'chevron-back-outline'"
                          slot="start"
                          role="button"
                          (click)="(null)"
                        ></ion-icon>
                      </ng-container>
                    </ion-item>
                  </div>

                  <ion-accordion-group
                    class="example-headers-align bg-transparent animate__animated animate__fadeIn"
                    [multiple]="false"
                    *ngIf="workflow"
                    (ionChange)="(null)"
                    id="accordion"
                  >
                    <ion-accordion
                      class="bg-transparent"
                      [value]="'characters'"
                    >
                      <ion-item slot="header" class="primary-text">
                        <ion-label class="p">Characters</ion-label>
                      </ion-item>
                      <div class="ion-padding" slot="content">
                        <div class="w-100 py-2 pb-3">
                          <app-search-bar
                            [placeholder]="'Search Characters'"
                            [workflow]="workflow"
                            [sceneData]="
                              selectedFile.data.ngArguments.scene.characters ??
                              []
                            "
                            [searchData]="workflow.characters"
                            (characterChanged)="addCharactersToScene($event)"
                          >
                          </app-search-bar>
                        </div>

                        <ng-container>
                          <div
                            class="w-100 row row-cols-2 justify-content-start g-0"
                            *ngIf="workflow"
                          >
                            <div
                              *ngFor="
                                let character of characterIds ?? [];
                                index as i
                              "
                              class="col p-1 position-relative"
                              style="aspect-ratio: 0.75"
                            >
                              <div
                                class="d-flex justify-content-between align-items-center flex-column border-table rounded secondary-background shadow-hover position-absolute"
                                style="overflow: hidden"
                                role="button"
                                *ngIf="workflow.characters[character] as c"
                                (click)="editCharacterDetails(character)"
                              >
                                <img
                                  class="w-100 h-100"
                                  style="object-fit: cover; aspect-ratio: 1"
                                  [src]="c.img"
                                />

                                <div
                                  class="w-100 primary-background py-2 d-flex justify-content-center align-items-center"
                                >
                                  <p
                                    class="mx-auto primary-text text-truncate text-center"
                                    style="width: 70px"
                                  >
                                    {{ c.name }}
                                  </p>
                                </div>
                              </div>

                              <div
                                class="rounded-circle bg-orange position-absolute"
                                style="
                                  z-index: 1;
                                  right: 0;
                                  top: 0;
                                  aspect-ratio: 1 !important;
                                "
                                role="button"
                                (click)="removeCharacter(i)"
                              >
                                <mat-icon
                                  class="w-100 h-100 primary-text-dark d-flex justify-content-center align-items-center p-1"
                                  style="font-size: small"
                                >
                                  close
                                </mat-icon>
                              </div>
                            </div>
                          </div>
                        </ng-container>
                      </div>
                    </ion-accordion>

                    <ion-accordion class="bg-transparent" [value]="'assets'">
                      <ion-item slot="header" class="primary-text">
                        <ion-label class="p">3D Assets</ion-label>
                      </ion-item>
                      <div class="ion-padding" slot="content">
                        <div class="w-100 py-2 pb-3">
                          <app-search-bar
                            [placeholder]="'Search 3D Assets'"
                            [workflow]="workflow"
                            [sceneData]="
                              selectedFile.data.ngArguments.scene.assets ?? []
                            "
                            [searchData]="workflow.assets"
                            (characterChanged)="addAssetToScene($event)"
                          >
                          </app-search-bar>
                        </div>

                        <ng-container>
                          <div
                            class="w-100 row row-cols-2 justify-content-start g-0"
                            *ngIf="workflow"
                          >
                            <div
                              *ngFor="let asset of assetIds ?? []; index as i"
                              class="col p-1 position-relative"
                              style="aspect-ratio: 0.75"
                            >
                              <div
                                class="d-flex justify-content-between align-items-center flex-column border-table rounded secondary-background shadow-hover position-absolute"
                                style="overflow: hidden"
                                role="button"
                                #col
                                *ngIf="workflow.assets[asset] as a"
                                (click)="editAssetDetails(asset, i)"
                              >
                                <img
                                  class="w-100 h-100"
                                  style="object-fit: cover; aspect-ratio: 1"
                                  [src]="a.img"
                                />

                                <div
                                  class="w-100 primary-background py-2 d-flex justify-content-center align-items-center"
                                >
                                  <p
                                    class="mx-auto primary-text text-truncate text-center"
                                    style="width: 70px"
                                  >
                                    {{ a.name }}
                                  </p>
                                </div>
                              </div>

                              <div
                                class="rounded-circle bg-orange position-absolute"
                                style="
                                  z-index: 1;
                                  right: 0;
                                  top: 0;
                                  aspect-ratio: 1 !important;
                                "
                                role="button"
                                (click)="removeAsset(i)"
                              >
                                <mat-icon
                                  class="w-100 h-100 primary-text-dark d-flex justify-content-center align-items-center p-1"
                                  style="font-size: small"
                                >
                                  close
                                </mat-icon>
                              </div>
                            </div>
                          </div>
                        </ng-container>
                      </div>
                    </ion-accordion>
                  </ion-accordion-group>

                  <button
                    class="btn bg-orange w-100 border-0 rounded fw-bold text-white d-flex justify-content-center px-3 align-content-center py-2 mt-4"
                    (click)="selectWorld()"
                  >
                    Explore World
                  </button>
                </div>
              </div>
            </ng-template>
          </mat-tab>
          <mat-tab class="tab">
            <ng-template mat-tab-label>
              <span class="primary-text"> GENERAL </span>
              <!-- <mat-icon class="primary-text"> info </mat-icon> -->
            </ng-template>
            <ng-template matTabContent>
              <div
                class="h-100 d-flex justify-content-center align-items-center flex-column position-relative"
              >
                <div
                  class="w-100 h-100 p-3 pb-5"
                  style="overflow-y: scroll"
                  *ngIf="selectedFile"
                >
                  <div class="w-100 pb-3">
                    <p class="w-100 mb-3 fw-bold primary-text">Image</p>

                    <div
                      class="position-relative d-flex justify-content-center align-items-center w-100 secondary-background"
                      style="aspect-ratio: 1"
                      role="button"
                      (click)="sceneImg.click()"
                    >
                      <ng-container
                        *ngIf="
                          selectedFile.data.ngArguments.scene.images[0] as img;
                          else emptyImg
                        "
                      >
                        <img
                          class="w-100 h-100 rounded position-absolute"
                          style="object-fit: cover"
                          [src]="img"
                        />
                        <div
                          class="w-100 h-100 position-absolute d-flex justify-content-center align-items-center img-show"
                          style="z-index: 1"
                        >
                          <mat-icon class="m-auto primary-text">
                            upload_file
                          </mat-icon>
                        </div>
                      </ng-container>

                      <ng-template #emptyImg>
                        <div
                          class="w-100 h-100 d-flex justify-content-center align-items-center flex-column p-3 empty-img-show"
                        >
                          <ion-icon
                            class="primary-text h1"
                            name="image-outline"
                          ></ion-icon>
                          <span
                            class="mt-2 h5 primary-text w-100 text-truncate text-center"
                            >No Image</span
                          >
                        </div>
                      </ng-template>
                    </div>

                    <input
                      #sceneImg
                      type="file"
                      (change)="fileChangeEvent($event)"
                      style="display: none"
                    />
                  </div>

                  <div class="w-100 pb-3">
                    <verticalai-text-field
                      [title]="'Name'"
                      [value]="selectedFile.data.ngArguments.scene.name"
                      [placeholder]="'Scene Name'"
                      (changed)="
                        updateCellName(selectedFile.id!, $event); saveLayout()
                      "
                    >
                    </verticalai-text-field>
                  </div>

                  <div class="w-100 pb-3">
                    <verticalai-textbox
                      [title]="'Description'"
                      [value]="selectedFile.data.ngArguments.scene.description"
                      [placeholder]="'Scene Description'"
                      (changed)="
                        updateCellDesc(selectedFile.id!, $event); saveLayout()
                      "
                    >
                    </verticalai-textbox>
                  </div>

                  <!-- <ng-container
                *ngIf="
                  selectedFile.type == 'gpt-LLM' ||
                  selectedFile.type == 'switch' ||
                  selectedFile.type == 'dalle-TIM'
                "
              >
                <div class="w-100 pb-3">
                  <verticalai-textbox
                    [title]="'Guidance'"
                    [value]="selectedFile.properties['systemPrompt']"
                    [placeholder]="placeholders[selectedFile.type]"
                    (changed)="
                      selectedFile.properties['systemPrompt'] = $event;
                      saveLayout()
                    "
                  >
                  </verticalai-textbox>
                </div>
  
                <div
                  class="w-100 pb-3"
                  *ngIf="
                    selectedFile.type == 'gpt-LLM' ||
                    selectedFile.type == 'dalle-TIM'
                  "
                >
                  <verticalai-layout-slider
                    [value]="selectedFile.properties['temp'] ?? 0.5"
                    [title]="'Creativity Level'"
                    [lineFillColor]="'#0A99FF'"
                    (valueChange)="
                      selectedFile.properties['temp'] = $event; saveLayout()
                    "
                  >
                  </verticalai-layout-slider>
                </div>
  
                <ng-container *ngIf="selectedFile.type == 'switch'">
                  <ng-container
                    *ngIf="selectedFile | cast : BranchedStep as branchStep"
                  >
                    <div
                      class="w-100 d-flex justify-content-between align-content-center pb-3 mb-3 mt-4 primary-text border-table-bottom"
                    >
                      <p class="w-100 fw-bold">Decision Paths</p>
                      <mat-icon
                        class="m-auto primary-text"
                        role="button"
                        (click)="newBranch(branchStep)"
                      >
                        add
                      </mat-icon>
                    </div>
  
                    <div class="w-100">
                      <div
                        *ngFor="
                          let branch of (branchStep.branches | dictToArr) ??
                            [];
                          index as i
                        "
                        class="pb-4 d-flex justify-content-between align-items-center"
                      >
                        <div class="primary-text">
                          {{ branch.name }}
                        </div>
  
                        <div
                          class="btn bg-orange shadow-0 text-white fw-bold rounded d-flex p-1 justify-content-center align-items-center"
                          (click)="
                            onRightClick($event, branch.name, branchStep)
                          "
                        >
                          <ion-icon
                            class="m-auto"
                            [name]="'settings-outline'"
                            slot="end"
                            role="button"
                            [matTooltip]="'Actions'"
                          ></ion-icon>
                        </div>
                      </div>
                    </div>
                  </ng-container>
                </ng-container>
  
                <ng-container *ngIf="selectedFile.type == 'gpt-LLM'">
                  <ng-container
                    *ngIf="
                      selectedFile.properties['training'] ??
                      'none' as training
                    "
                  >
                    <div class="w-100 pb-3">
                      <verticalai-select-field
                        [title]="'Training'"
                        [value]="training ?? trainingTypes[0].id"
                        [data]="trainingTypes"
                        [valueField]="'id'"
                        [displayField]="'name'"
                        (changed)="
                          selectedFile.properties['training'] = $event;
                          saveLayout()
                        "
                      >
                      </verticalai-select-field>
                    </div>
  
                    <div class="w-100 pb-3" *ngIf="training != 'none'">
                      <verticalai-select-field
                        *ngIf="
                          loadedDocs && loadedDocs.length > 0;
                          else empty
                        "
                        [title]="'Training Data'"
                        [value]="
                          selectedFile.properties['autoId'] ?? loadedDocs[0]
                        "
                        [data]="loadedDocs"
                        (changed)="
                          selectedFile.properties['autoId'] = $event;
                          saveLayout()
                        "
                      >
                      </verticalai-select-field>
  
                      <ng-template #empty>
                        <verticalai-select-field
                          [title]="'Training Data'"
                          [value]="'No Data'"
                          [data]="['No Data']"
                        >
                        </verticalai-select-field>
                      </ng-template>
                    </div>
                  </ng-container>
                </ng-container>
              </ng-container>
  
              <ng-container *ngIf="selectedFile.type == 'container'">
                <div
                  class="w-100 d-flex justify-content-center align-items-center"
                  style="height: 400px"
                >
                  <div class="secondary-text">
                    No settings for this controller
                  </div>
                </div>
              </ng-container>
  
              <ng-container
                *ngIf="
                  (
                    models[(selectedFile.type | split : '-')[1]] ??
                    { models: {} }
                  ).models[selectedFile.type]?.variations as variations
                "
              >
                <div class="w-100 pb-3" *ngIf="variations.length > 0">
                  <verticalai-select-field
                    [title]="'Type'"
                    [value]="
                      selectedFile.properties['engine'] ??
                      variations[0]?.id ??
                      ''
                    "
                    [data]="variations"
                    [valueField]="'id'"
                    [displayField]="'name'"
                    (changed)="
                      selectedFile.properties['engine'] = $event; saveLayout()
                    "
                  >
                  </verticalai-select-field>
                </div>
              </ng-container> -->
                </div>
              </div>
            </ng-template>
          </mat-tab>
        </mat-tab-group>
      </div>
    </div>
  </div>
</div>
